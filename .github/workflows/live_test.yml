name: Live Trace Test

on:
  workflow_dispatch:
    inputs:
      duration_seconds:
        description: 'Test duration in seconds'
        required: false
        default: '90'
        type: string
      steps:
        description: 'Number of traces to generate'
        required: false
        default: '60'
        type: string
  schedule:
    # Her gece 02:00 UTC'de çalış (nightly test)
    - cron: '0 2 * * *'

jobs:
  live_test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run live trace test
      run: |
        duration=${INPUT_DURATION_SECONDS:-90}
        steps=${INPUT_STEPS:-60}
        sleep_interval=$(echo "scale=2; $duration / $steps" | bc)
        echo "Running live test: $steps steps, ~$duration seconds total"
        python tools/realtime_ci.py --steps $steps --sleep $sleep_interval --profile scenario_test --output traces_live.jsonl

    - name: Generate CSV export
      run: |
        python -c "
        import json
        import csv
        from pathlib import Path
        
        jsonl_path = Path('traces_live.jsonl')
        csv_path = Path('traces_live.csv')
        
        with open(jsonl_path, 'r', encoding='utf-8') as f:
            traces = [json.loads(line) for line in f if line.strip()]
        
        if not traces:
            print('No traces found')
            exit(1)
        
        fieldnames = ['t', 'level', 'cus', 'raw_action', 'final_action', 'human_escalation', 'confidence', 'latency_ms']
        with open(csv_path, 'w', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=fieldnames, extrasaction='ignore')
            writer.writeheader()
            for trace in traces:
                row = {k: trace.get(k) for k in fieldnames}
                row['raw_action'] = str(row.get('raw_action', []))
                row['final_action'] = str(row.get('final_action', []))
                writer.writerow(row)
        
        print(f'✅ CSV exported: {len(traces)} traces')
        "

    - name: Upload traces as artifact
      uses: actions/upload-artifact@v4
      with:
        name: traces_live_${{ github.run_number }}
        path: |
          traces_live.jsonl
          traces_live.csv
        retention-days: 30

    - name: Summary
      run: |
        lines=$(wc -l < traces_live.jsonl)
        echo "## Live Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Generated traces: $lines" >> $GITHUB_STEP_SUMMARY
        echo "- Files: traces_live.jsonl, traces_live.csv" >> $GITHUB_STEP_SUMMARY
        echo "- Artifact: traces_live_${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
