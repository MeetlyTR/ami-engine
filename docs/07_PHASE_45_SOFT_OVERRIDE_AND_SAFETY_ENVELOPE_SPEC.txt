# Phase 4.5 — Soft Override & Adaptive Safety Envelope (Mini-Spec)

**AMI-ENGINE:** Belirsizliği sadece ölçmek değil; **davranışa dönüştüren** 3 seviyeli escalation ve aksiyon uzayı kısıtlaması.

Referans: 06_PHASE_44_COGNITIVE_UNCERTAINTY_SPEC, 04_QUALITY_AND_PHASE4_SPEC, 01_STATE_SPACE_AND_CONSTRAINTS (aksiyon uzayı).

---

# 1. Amaç

- **Level 0:** Normal mod; tüm aksiyon alanı açık.
- **Level 1 (Soft-Safe):** Zararı minimize et, geri dönüşü açık tut; aksiyon uzayı daraltılır (fail-soft).
- **Level 2 (Hard Fail-Safe):** Mevcut override: safe_action + human_escalation.

Sonuç: Karar sistemi **binary değil continuous** — belirsizlik ölçülür ve davranışı şekillendirir.

---

# 2. Matematik ve Kurallar

## 2.1 Escalation Seviyesi

Girdi: confidence, constraint_margin, H, H_CRITICAL (config).

  escalation = 2   if (confidence < CONFIDENCE_ESCALATION_FORCE) or (H > H_CRITICAL)
             = 1   else if constraint_margin < 0
             = 0   else

- **2:** Hard fail-safe (mevcut mantık; safe_action, human_escalation).
- **1:** Soft-safe; aday aksiyonlar restrict_action_space ile filtrelenir; fail_safe override yok ama davranış kısıtlı.
- **0:** Normal; tüm constraint-geçer adaylar üzerinden argmax.

## 2.2 Soft-Safe Aksiyon Uzayı (Level 1)

Aksiyon: a = [severity, compassion, intervention, delay] ∈ [0,1]^4 (01_STATE_SPACE).

**Operasyonel kısıtlar (fail-soft):**

  severity     ≤ SEVERITY_SOFT_MAX   (örn. 0.6)
  intervention ≤ INTERVENTION_SOFT_MAX  (örn. 0.5)
  delay        ≥ DELAY_SOFT_MIN      (örn. 0.3)

Amaç: Sert müdahaleleri yasakla; geçici ve düşük etkili aksiyonlara yönel.

**Config sabitleri (config veya profile):**
  SEVERITY_SOFT_MAX = 0.6
  INTERVENTION_SOFT_MAX = 0.5
  DELAY_SOFT_MIN = 0.3

## 2.3 Action Spread (AS) ile Soft-Safe Tetikleme (Opsiyonel Zenginleştirme)

Phase 4.4’te AS = max(score) − second_max(score). AS düşükse “net lider yok”.

  if escalation == 0 and AS_norm < AS_SOFT_THRESHOLD:
      escalation = 1   # Karar kararsızsa da soft-safe’e geç

AS_SOFT_THRESHOLD örn. 0.3 (config). Bu, **karar kararlılığına dayalı güvenlik** sağlar.

## 2.4 Confidence–Uncertainty Divergence (D) ile Hard Trigger (Opsiyonel)

Phase 4.4: D = | confidence − (1 − DE_norm) |. D büyükse “fazla özgüvenli ama kararsız”.

  if D > DIVERGENCE_HARD_THRESHOLD:
      escalation = 2   # Özgüven–belirsizlik uyumsuzluğu → insan eskalasyonu

DIVERGENCE_HARD_THRESHOLD örn. 0.5 (config). İlk aşamada opsiyonel; denetim/sertifikasyon için güçlü.

---

# 3. Kod Mimarisi

## 3.1 Yeni Modül: core/soft_override.py

**restrict_action_space(candidates, severity_max, intervention_max, delay_min)**

  candidates: List[(action, MoralScores)], action = [s, c, i, d]
  Döndür: Filtrelenmiş liste; severity ≤ severity_max, intervention ≤ intervention_max, delay ≥ delay_min.

**compute_escalation_level(confidence, constraint_margin, H, h_crit, config)**

  Döndür: 0 | 1 | 2.

**Opsiyonel:** compute_escalation_level içinde AS_norm ve D kullanımı (Phase 4.4 çıktıları verilirse).

## 3.2 Engine Pipeline Değişikliği

Sıra (mevcut + yeni adımlar):

1. encode_state, generate_actions, moral_scores, constraint_validator → **candidates**.
2. fail_safe(worst_J, worst_H) → **fs** (override, human_escalation, safe_action).
3. **Yeni:** confidence + constraint_margin hesapla (mevcut B.3); isteğe bağlı Phase 4.4 uncertainty (HI, DE, AS, CUS, D).
4. **Yeni:** escalation = compute_escalation_level(..., config).
5. **Yeni:** if escalation == 2 → mevcut davranış (sel = safe_action, human_escalation). if escalation == 1 → candidates = restrict_action_space(candidates, ...); sonra select_action(candidates, ...) — fail_safe override kullanılmaz bu dalda. if escalation == 0 → mevcut select_action(candidates, fs, weights).
6. Trace’e escalation, soft_safe_applied (bool), (Level 1’de) filtered_candidate_count eklenir.

**Önemli:** Level 1’de fail_safe.override False kalır; sadece aday kümesi kısıtlanır. Level 2’de mevcut fail_safe mantığı aynen.

## 3.3 Config / Profile

Tüm eşikler config veya profile’dan okunur:

  CONFIDENCE_ESCALATION_FORCE = 0.20   (mevcut)
  SEVERITY_SOFT_MAX = 0.6
  INTERVENTION_SOFT_MAX = 0.5
  DELAY_SOFT_MIN = 0.3
  AS_SOFT_THRESHOLD = 0.3              (opsiyonel)
  DIVERGENCE_HARD_THRESHOLD = 0.5       (opsiyonel)

Profile (production_safe, high_critical) bu değerleri override edebilir.

---

# 4. Test Planı

## 4.1 Birim (core/soft_override.py)

- restrict_action_space: Tüm adaylar kısıtı ihlal ediyorsa boş liste dönmez; en az “hiçbir şey yapma” [0,0,0,1] delay≥0.3 sağlar → liste boş olmamalı veya fallback tanımlı olmalı.
- restrict_action_space: severity 0.7 olan aksiyon 0.6 limitte elenir; 0.5 olan kalır.
- compute_escalation_level: confidence=0.15 → 2; constraint_margin=−0.2, confidence=0.5 → 1; margin=0.2, confidence=0.8 → 0.

## 4.2 Entegrasyon (engine.py)

- Belirli raw_state ile escalation=1 üretilebilecek config (örn. margin<0, confidence>0.2, H≤H_CRITICAL) → çıktıda escalation=1, soft_safe_applied=True.
- escalation=2 durumunda action = SAFE_ACTION, human_escalation=True.
- Trace step 6’da escalation, soft_safe_applied alanları mevcut.

## 4.3 Chaos Entegrasyonu

- Her config varyantında: escalation 0/1/2 kuralları korunur (J<J_min → override vb. invariant’lar profile’a göre).
- Soft-safe eşikleri (SEVERITY_SOFT_MAX vb.) grid’e eklenebilir; invariant: Level 1’de seçilen aksiyon soft kısıtları sağlar.

## 4.4 Monte Carlo

- Runner: Her kayıtta escalation (0/1/2), soft_safe_applied kaydedilir.
- Rapor: escalation dağılımı (%), ortalama CUS/AS by escalation level.

## 4.5 Replay

- Trace’te escalation ve soft_safe_applied varsa replay sonrası aynı değerler assert edilir.

---

# 5. Chaos + Monte Carlo Entegrasyonu (Özet)

- **Chaos:** Parametre grid’ine isteğe bağlı SEVERITY_SOFT_MAX, DELAY_SOFT_MIN vb. eklenir. Invariant: escalation seviyesi ile tutarlı davranış; Level 1’de seçilen aksiyon soft kısıtları ihlal etmez.
- **Monte Carlo:** Rastgele state’lerde escalation dağılımı ve uncertainty (CUS, AS) ile korelasyon raporlanır.

---

# 6. Adaptive Safety Envelope (Phase 4.6 Tohumu)

Bu belge “Adaptive Ethics” (Phase 4.6) için zemin tanımlar:

- Geçmiş Chaos + Monte Carlo sonuçlarına göre eşiklerin (J_MIN, H_MAX, SEVERITY_SOFT_MAX, AS_SOFT_THRESHOLD vb.) otomatik tune edilmesi.
- Phase 4.5’te eşikler **statik** (config/profile); Phase 4.6’da “öğrenen eşikler” olarak genişletilebilir.

---

# 7. Uygulama Sırası

1. config: SEVERITY_SOFT_MAX, INTERVENTION_SOFT_MAX, DELAY_SOFT_MIN (ve opsiyonel AS_SOFT_THRESHOLD, DIVERGENCE_HARD_THRESHOLD).
2. core/soft_override.py: restrict_action_space, compute_escalation_level.
3. engine.py: Pipeline’a escalation hesaplama ve Level 1’de restrict_action_space uygulama; trace’e escalation, soft_safe_applied.
4. tests/soft_override/: Birim testleri.
5. Chaos grid + invariant: Level 1 soft kısıtları.
6. Monte Carlo runner/report: escalation ve soft_safe_applied.
7. Replay: escalation ve soft_safe_applied doğrulama.

---

# 8. Nihai Tanım

Phase 4.5 tamamlandığında:

- Motor **3 seviyeli escalation** (0 normal, 1 soft-safe, 2 hard fail-safe) uygular.
- Belirsizlik (constraint_margin, isteğe bağlı AS/D) **davranışı şekillendirir** (aksiyon uzayı kısıtlaması).
- Trace ve raporlama escalation ve soft_safe_applied ile **denetlenebilir**.
- Sistem: **Kendi riskini ölçen ve ona göre kendini kısıtlayan** etik karar motoru seviyesine gelir.

Bu spec, Soft Override & Adaptive Safety Envelope’un tek referans dokümanıdır.
