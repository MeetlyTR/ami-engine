# Phase 6.0 — Offline Learning Loop (Mini-Spec)

**AMI-ENGINE:** Statik akıllı motordan dinamik akıllı motora — trace'lerden öğrenerek eşik ve clamp parametrelerini otomatik ayarlama.

Referans: Phase 4.7 (Trace, Dashboard), 00_ARCHITECTURE_STATUS.

---

# 1. Amaç

Sistem şunu öğrensin:

> "Hangi koşullarda gereksiz yere fail-safe'e kaçıyorum?"

Hedef davranış:

- L2 (fail-safe) oranı makul seviyede kalsın; gereksiz artış azalsın.
- Ortalama CUS düşsün (daha kararlı belirsizlik).
- Soft clamp çok agresif olmasın (clamp_distortion sınırlı).

---

# 2. Veri Kaynağı

- **traces.jsonl** (Phase 4.7.1 DecisionTrace formatı).
- Her satır: t, cus, delta_cus, cus_mean, raw_action, final_action, soft_clamp, level, confidence, delta_confidence, human_escalation, chaos.

İsteğe bağlı: Aynı state seti üzerinde farklı config ile engine tekrar çalıştırılıp yeni trace'ler üretilir (Monte Carlo / chaos jeneratörü ile state listesi).

---

# 3. Öğrenme Hedefi (Loss)

Basit ağırlıklı toplam:

```
L = w1 * fail_safe_rate + w2 * mean_CUS + w3 * clamp_distortion
```

Önerilen ağırlıklar (tune edilebilir):

- w1 = 1.5  (fail_safe oranını cezalandır)
- w2 = 1.0  (yüksek CUS cezalandır)
- w3 = 0.5  (aşırı clamp cezalandır)

Metrik tanımları:

- **fail_safe_rate:** level == 2 olan kayıt oranı (0–1).
- **mean_CUS:** Tüm kayıtların cus ortalaması (0–1).
- **clamp_distortion:** soft_clamp==True olan kayıtlarda, |final_action - raw_action| bileşen ortalaması (L1); clamp yoksa 0. Ortalama tüm kayıt üzerinde (0–1 aralığında kalacak şekilde normalize).

Amaç: L'yi minimize etmek.

---

# 4. Öğrenecek Parametreler ve Güvenlik Sınırları

| Parametre              | Rol                        | Önerilen sınır (min, max)   |
|------------------------|----------------------------|-----------------------------|
| J_MIN                  | Fail-safe adalet eşiği    | (0.50, 0.95)               |
| H_MAX                  | Zarar üst sınırı          | (0.15, 0.50)               |
| SOFT_CLAMP_ALPHA       | Severity clamp katsayısı   | (0.3, 0.9)                 |
| SOFT_CLAMP_BETA        | Intervention clamp        | (0.3, 0.9)                 |
| SOFT_CLAMP_GAMMA       | Delay clamp                | (0.2, 0.6)                 |
| DELTA_CUS_THRESHOLD    | Drift alarm eşiği         | (0.05, 0.25)               |
| CUS_MEAN_THRESHOLD     | CUS ortalama eşiği        | (0.50, 0.85)               |

Tüm önerilen config değişiklikleri bu sınırlar içinde kalmalı; aşıyorsa clamp'lenir.

---

# 5. Modül Mimarisi

```
learning/
  __init__.py
  feedback_metrics.py   # Trace'lerden fail_safe_rate, mean_cus, clamp_distortion
  loss.py              # L = w1*fail_safe_rate + w2*mean_cus + w3*clamp_distortion
  policy_optimizer.py   # Parametre uzayı, aday config üretimi (grid / rastgele)
  offline_loop.py       # State seti + config → engine çalıştır → trace → L → en iyi config
```

Veri akışı:

```
traces.jsonl  veya  [states] + config
       ↓
feedback_metrics (fail_safe_rate, mean_cus, clamp_distortion)
       ↓
loss (L)
       ↓
policy_optimizer (aday config'ler)
       ↓
offline_loop: her aday için engine(state, config) → trace → L → argmin
       ↓
önerilen config (ve isteğe config_profiles veya config override dosyası)
```

---

# 6. Güvenlik Kuralları

- Learning çıktısı **canlı motora otomatik enjekte edilmez**. Çıktı: önerilen config dict veya dosya; insan onayı veya regression test sonrası uygulanır.
- Parametreler her zaman tanımlı min/max içinde tutulur.
- Chaos invariant'ları (J_MIN, H_MAX, [0,1]^4) öğrenme sonrası da geçerli kalacak şekilde sınırlar seçilir.
- İsteğe: Önerilen config ile replay / Monte Carlo / chaos testi; başarısızsa config kabul edilmez.

---

# 7. Phase 6.1 (İleride)

- Online adaptation: Periyodik trace toplama + offline benzeri güncelleme (yavaş, güvenli adımlar).
- Predictive safety: CUS/drift tahmini ile proaktif eşik ayarı.

---

Bu spec, Phase 6.0 Offline Learning Loop'un referans dokümanıdır.
