# B.3 — Ethical Confidence & Constraint Margin (Kodlanabilir Spesifikasyon)

Referans: 04_QUALITY_AND_PHASE4_SPEC.txt §B.3

---

## 1. Amaç

Her karar için:
- **confidence** ∈ [0, 1]: etik güven endeksi
- **constraint_margin**: kısıta en yakın mesafe (risk yakınlığı)

Kullanım: Phase 4.1 adversarial, 4.2 Monte Carlo, 4.3 chaos; human escalation önerisi.

---

## 2. Matematik (3 Katman)

### Katman 1 — Standart sapma tabanlı belirsizlik

  scores = (W, J, H, C)
  σ = std(W, J, H, C)
  σ_max = 0.5   # [0,1]^4 için maksimum std
  σ_norm = σ / σ_max
  base_confidence = 1 − σ_norm  # [0, 1] clamp

Skorlar birbirinden ne kadar ayrışıyorsa → etik gerilim → base_confidence düşer.

### Katman 2 — Constraint margin + non-linear baskı

  constraint_margin = min(
      J − J_min,
      H_max − H,
      min(C − C_min, C_max − C)
  )

(Bir değer negatifse margin negatif; sınıra yakın veya ihlal.)

  margin_factor = sigmoid(k * constraint_margin)
  sigmoid(x) = 1 / (1 + exp(−x))

k = 8 (config): sınıra yaklaşınca hızlı düşüş.

### Katman 3 — Nihai confidence

  confidence = base_confidence * margin_factor

Clamp: confidence ∈ [0, 1].

---

## 3. Config Parametreleri

| Parametre | Varsayılan | Anlam |
|-----------|------------|--------|
| SIGMA_MAX | 0.5 | [0,1] skorlar için max std |
| CONFIDENCE_MARGIN_K | 8 | sigmoid keskinliği |
| CONFIDENCE_ESCALATION_SUGGEST | 0.35 | altında → trace’e “human review öner” |
| CONFIDENCE_ESCALATION_FORCE | 0.20 | altında → human_escalation = true (mevcutla OR) |

---

## 4. API

**core/confidence.py**

  compute_confidence(scores, config=None) → ConfidenceResult

  ConfidenceResult:
    confidence: float
    constraint_margin: float
    base_confidence: float
    margin_factor: float
    suggest_escalation: bool   # confidence < 0.35
    force_escalation: bool     # confidence < 0.20

scores: MoralScores veya dict {W, J, H, C}.

---

## 5. Pipeline Entegrasyonu

- selection (step 6) sonrası seçilen aksiyonun skorları ile compute_confidence çağrılır.
- step 6 data’ya eklenir: confidence, constraint_margin, base_confidence, margin_factor, suggest_escalation, force_escalation.
- human_escalation = fs.human_escalation OR force_escalation.
- Motor çıktısına confidence, constraint_margin eklenir.

---

## 6. Test Senaryoları

| Senaryo | Beklenti |
|---------|----------|
| Skorlar uyumlu, kısıttan uzak | confidence yüksek, margin_factor ≈ 1 |
| Skorlar dağınık, kısıt güvenli | orta confidence |
| Constraint sınırında | düşük confidence, margin_factor düşük |
| Fail-safe yakın (J düşük, H yüksek) | çok düşük confidence, force_escalation mümkün |

---

Bu spec ile B.3 doğrudan kodlanabilir; Phase 4.1–4.3 analizleri confidence metriğine dayanır.
