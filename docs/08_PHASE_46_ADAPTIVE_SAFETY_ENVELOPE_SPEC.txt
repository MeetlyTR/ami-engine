# Phase 4.6 — Adaptive Safety Envelope (Mini-Spec)

**AMI-ENGINE:** Config profile + chaos-driven threshold tuning.

Referans: 07_PHASE_45, Phase 4.2 Monte Carlo, Phase 4.3 Chaos.

---

# 1. Amaç

- **Statik eşikler** yerine profile tabanlı rejimler: base, production_safe, high_critical.
- **Hedef escalation dağılımı:** L0 %70–90, L1 %5–25, L2 %0.5–3.
- **Tuning:** Monte Carlo + loss (hedef − gözlenen) → en iyi eşik seti.

---

# 2. Config Profile Mimarisi

## 2.1 Paket: config_profiles/

- **base.py:** DEFAULT_CONFIG (config.py ile senkron; J_MIN, H_MAX, C_MIN, C_MAX, J_CRITICAL, H_CRITICAL, CONFIDENCE_ESCALATION_FORCE, SEVERITY_SOFT_MAX, INTERVENTION_SOFT_MAX, DELAY_SOFT_MIN, AS_SOFT_THRESHOLD, DIVERGENCE_HARD_THRESHOLD, ESCALATION_HYSTERESIS).
- **production_safe.py:** CONFIG = { **DEFAULT_CONFIG, J_MIN: 0.65, H_MAX: 0.40, ... } — daha gevşek, L0 ağırlıklı.
- **high_critical.py:** CONFIG = { **DEFAULT_CONFIG, J_MIN: 0.85, H_MAX: 0.25, ... } — sıkı, güvenlik öncelikli.

## 2.2 Loader

- **get_config(profile_name) → dict.** Engine config_override olarak kullanır.
- **list_profiles() → [ "base", "production_safe", "high_critical", "chaos_tuning" ].**
- **chaos_tuning:** Eşikleri bilerek gevşek (J_MIN 0.55, H_MAX 0.55, J_CRITICAL 0.35, CONFIDENCE_ESCALATION_FORCE 0.12, vb.). L0/L1 zengin veri ve tuning runner için; prod için değil.

## 2.3 Engine Entegrasyonu

- **config_override: Union[dict, str].** str ise get_config(profile_name) ile dict yüklenir.

---

# 3. Tuning Runner (tools/tune_thresholds.py)

- **Girdi:** --profile, --mc-n, --seed, --target L0 L1 L2 (varsayılan 0.80 0.15 0.03), --grid (adım sayısı).
- **Loss:** L = (p0−t0)^2 + (p1−t1)^2 + 3*(p2−t2)^2 (Level 2 sapmasına daha yüksek ceza).
- **Arama:** Profile'dan başlayan config üzerinde J_MIN, H_MAX, AS_SOFT_THRESHOLD, DIVERGENCE_HARD_THRESHOLD grid taraması.
- **Çıktı:** En düşük loss’lu config (Best config: J_MIN=..., H_MAX=..., vb.) ve gözlenen escalation dağılımı.

---

# 4. Hedef Dağılım

| Level | Hedef Oran |
| ----- | ---------- |
| 0     | %70 – %90  |
| 1     | %5 – %25   |
| 2     | %0.5 – %3  |

Mevcut moral_evaluator çıktılarına göre grid aralıkları (J_MIN, H_MAX vb.) tuning script içinde ayarlanabilir; L0 görmek için daha gevşek eşik gerekebilir.

---

# 5. Phase 5 Tohumu: Temporal Drift

- CUS(t) − CUS(t−1) > δ → preemptive soft-safe (ileride erken uyarı).
- Phase 4.6’da sadece profile + tuning; temporal state Phase 5’te.

---

# 6. Nihai Tanım

Phase 4.6 tamamlandığında:

- Motor **profile adı** ile çağrılabilir (production_safe, high_critical).
- **tune_thresholds.py** ile hedef escalation dağılımına yakın eşik seti aranır.
- Sistem: **kendi güvenlik parametrelerini chaos + MC ile tune edebilen** altyapıya sahip olur.

Bu spec, Adaptive Safety Envelope’un referans dokümanıdır.
