# 04_QUALITY_AND_PHASE4_SPEC.txt

**AMI-ENGINE — Kalite Sertifikasyonu & Phase 4 Stres Test Çerçevesi**

Bu belge: ami-engine'in endüstriyel kalite ve stres test anayasasıdır.
Referans: 00_ETHICAL_CONTROL_THEORY, 01_STATE_SPACE_AND_CONSTRAINTS, 02_MORAL_DECISION_ENGINE_SPEC, 03 (implementasyon).

---

# BÖLÜM A — STRATEJİK MİMARİ KARARLAR

## A.1 Çekirdek mi, Ajan mı?

**Karar:** Saf etik çekirdek + ileride agent adapter.

- ami-engine = saf moral kernel (state → action + trace + confidence).
- Üstüne agent-adapter katmanı:
  - robot_adapter
  - digital_assistant_adapter
  - autonomous_system_adapter
- Çekirdek asla ajan bağımlılığı taşımaz; her ajan sadece adaptör yazar.

---

## A.2 Sabit Anayasa mı, Adaptive mi?

**Karar:**

- Phase 1–4: **Sabit etik anayasa** (parametreler config’te, versiyonlanır).
- Phase 5+: **Controlled adaptive calibration** (ayrı modül).

Kural:

- learning ≠ decision
- learning → sadece parameter calibration (insan onaylı, versioned).
- Karar motoru deterministik kalır; öğrenme sadece parametre güncellemesi üretir.

---

## A.3 Açık Kaynak mı, Özel Çekirdek mi?

**Strateji:**

- Çekirdek mimari + Ethical Control Theory → açık bilim / yayınlanabilir.
- Ürünleştirme ve ajan entegrasyonu → özel deployment.

Bu üçlüyü sağlar: akademik değer, endüstriyel güç, etik güvenilirlik.

---

# BÖLÜM B — 6 KALİTE İYİLEŞTİRMESİ (NİHAİ TASARIM)

---

## B.1 Decision Stability Filter — EMA Tabanlı Etik Yumuşatma

**Amaç:** Aynı state’te küçük oynamalarda aksiyonun zıplamasını engellemek.

**Kesin formül:**

  a_final = α * a_new + (1−α) * a_prev

- α = 0.7 (config: STABILITY_ALPHA).
- a_prev: bir önceki karar çıktısı (ilk çağrıda a_prev = a_new veya safe_action).

**Pipeline yeri:**

  Action Selector → Stability Filter → Output

**State:** Motor yalnızca a_prev tutar (tek vektör). Minimum state, kontrol teorisine uyumlu.

**Kodlanabilirlik:**

- Modül: core/stability_filter.py
- Girdi: a_new (list[float]), a_prev (list[float] | None)
- Çıktı: a_final (list[float])
- a_prev None ise a_final = a_new.

---

## B.2 Moral Hysteresis Band — Fail-Safe Titreşim Önleyici

**Amaç:** Fail-safe ile normal mod arasında flip-flop (titreşim) oluşmasını engellemek.

**Kesin bölgeler:**

| Bölge        | J aralığı        | Davranış |
| ------------ | ----------------- | -------- |
| Normal       | J ≥ 0.85          | Normal optimizasyon. |
| Soft Warning | 0.70 ≤ J < 0.85  | Override yok. Warning log + düşük confidence işareti. |
| Fail-Safe    | J < 0.70          | Hard override + human_escalation = true. |

**Çıkış hysteresis (opsiyonel):**

- Fail-safe’ten çıkış için: J > 0.78 (giriş 0.70, çıkış 0.78 → band).

**Kodlanabilirlik:**

- config: J_SOFT_WARNING_MIN = 0.70, J_SAFE_EXIT = 0.78, J_MIN = 0.85.
- Fail-safe controller: mevcut J < 0.7 → override.
- Yeni: 0.70 ≤ J < 0.85 → trace’e event_type = "soft_warning", confidence düşükse log.

---

## B.3 Ethical Confidence Score — Karar Güven Endeksi

**Amaç:** Her karar için güven ölçüsü; düşük güven → human review / escalation önerisi.

**Formül:**

  confidence = 1 − normalized_std(W, J, H, C)

- normalized_std: std(W,J,H,C) / max_possible_std. [0,1] aralığında skorlar için max_possible_std sabit (örn. 0.5) veya hesaplanır.
- confidence ∈ [0, 1].

**Destek metrik — constraint margin:**

  constraint_margin = min(
    J − J_min,
    H_max − H,
    min(|C − C_min|, |C − C_max|)  // banda en yakın mesafe
  )

**Kullanım kuralları:**

- confidence < 0.35 → human escalation öner (trace’e yaz).
- confidence < 0.20 → otomatik human_escalation = true (fail-safe’ten bağımsız ek kriter).

**Kodlanabilirlik:**

- Modül: core/confidence.py
- Girdi: MoralScores (W,J,H,C), (opsiyonel) J_min, H_max, C_min, C_max
- Çıktı: confidence (float), constraint_margin (float)
- engine.py çıktısına confidence ve constraint_margin eklenir.

---

## B.4 Deterministic Replay Engine — Regülasyon Çekirdeği

**Amaç:** Aynı girdi ile kararın tekrarlanabilirliğini kanıtlamak (hukuki denetim, sertifikasyon).

**Kesin karar:**

- Trace içinde her zaman şunlardan biri saklanır:
  - raw_state (tercih), veya
  - encoded_state (x_ext, x_moral)
- Böylece replay girdisi eksiksiz olur.

**Replay semantiği:**

  engine.replay(trace) → (action, trace_new)

- trace’ten raw_state veya encoded_state okunur.
- moral_decision_engine(raw_state) veya encode_state sonrası aynı state ile pipeline tekrar çalıştırılır.
- Beklenti: action == replay_action (veya trace_new, aynı reason ve aynı skorlar).

**Kodlanabilirlik:**

- engine.py: trace oluşturulurken step 1’de raw_state veya state_encoded eklenir.
- engine.replay(trace): trace[0].data’dan state çıkarılır, moral_decision_engine(state) çağrılır, dönen action ve trace karşılaştırılır (opsiyonel assert).

---

## B.5 Ethics Regression Suite — Etik Davranış Kilidi

**Amaç:** Yeni kodun önceki etik davranışı bozmadığını garanti etmek.

**Golden dataset:**

  tests/regression/golden_cases.json

**Her vaka:**

- raw_state (dict)
- expected: action (veya reason, veya score aralığı)
- İsteğe bağlı: expected_reason, expected_human_escalation

**CI kuralı:**

- Her commit sonrası golden_cases üzerinde motor çalıştırılır.
- Yeni action vs expected: sapma %1’den fazla (veya tanımlı metrik) ise FAIL.
- Metrik: L2 norm(action - expected_action) < ε veya reason/override eşleşmesi.

**Kodlanabilirlik:**

- tests/regression/run_regression.py: golden_cases.json oku, motoru çalıştır, karşılaştır.
- Başlangıç: 5–10 golden senaryo (acil, fail-safe, pasif, soft-warning, vb.).

---

## B.6 Adversarial Stress Test Paketi — Phase 4 Çekirdeği

**Konum:**

  tests/adversarial/
    ├── extreme_compassion.py
    ├── justice_conflict.py
    ├── harm_explosion.py
    └── moral_drift_simulation.py

**Her test:**

- raw_state üretir (bilerek zorlayıcı).
- expected behavior tanımlar (assert).
- Motoru çalıştırır; fail-safe, reason, action, confidence doğrular.

**Test rolleri:**

| Dosya                    | Amaç |
| ------------------------ | ---- |
| extreme_compassion       | Aşırı merhamet → zayıflık üretmiyor mu? C bandında mı, fail-safe gereksiz tetiklenmiyor mu? |
| justice_conflict         | Adalet her zaman korunuyor mu? J < J_min → elenen aksiyon; J < 0.7 → override. |
| harm_explosion           | H yüksek senaryolarda fail-safe garanti; override ve human_escalation. |
| moral_drift_simulation   | Aynı state tekrarda aynı karar (replay); zamanla parametre değişmeden drift yok. |

Bu paket, Phase 4.1’in resmî uygulamasıdır.

---

# BÖLÜM C — PHASE 4: ETHICAL STRESS TESTING & SIMULATION FRAMEWORK

Phase 4 sorusu: “Bu motor gerçekten etik olarak dayanıklı mı?” — bilimsel cevap verir.

---

## C.1 Phase 4.1 — Adversarial Ethics Tests

**Amaç:** Sistemi bilerek zorlamak.

**İçerik:** B.6’daki tests/adversarial/ paketi.

**Ölçümler:**

- Tüm adversarial testlerin PASS.
- Extreme compassion → C ∈ [C_min, C_max], zayıflık (a_intervention=0 gereksiz) yok.
- Justice conflict → J ihlali yok, fail-safe doğru.
- Harm explosion → H > H_crit → override.
- Moral drift → replay aynı action.

---

## C.2 Phase 4.2 — Monte Carlo Ethical Simulation

**Amaç:** 10k–100k rastgele senaryo ile etik dağılım ve sapma analizi.

**Üretim:**

- Rastgele raw_state (physical, social, context, risk, moral bileşenler) [0,1] veya seçilmiş dağılımdan.
- Her state için motor çalıştırılır; action, W, J, H, C, confidence, override kaydedilir.

**Ölçümler:**

- mean(J), std(J); mean(H), std(H)
- fail-safe frequency (override oranı)
- confidence distribution (histogram)
- Constraint ihlal oranı (0 olmalı normal modda)

**Çıktı:** Etik istatistik raporu (dosya veya özet tablo). Sapma ve aykırı değerler işaretlenir.

---

## C.3 Phase 4.3 — Ethical Chaos Testing

**Amaç:** Parametrelerle oynanınca sistemin kırılıp kırılmadığını görmek; adalet asla ihlal edilmemeli.

**Örnek oynatmalar:**

- J_min: 0.85 → 0.7
- C band: daralt / genişlet
- Risk, severity aşırı değerler

**Beklenti:**

- Tüm parametre setlerinde J ≥ J_min (normal modda) veya override.
- Asla “J ihlal edildi ama override yok” durumu olmamalı.

**Kodlanabilirlik:**

- Parametre grid’i (config varyantları) + aynı golden/adversarial senaryolar.
- Her varyantta constraint ve fail-safe kuralları doğrulanır.

---

# BÖLÜM D — UYGULAMA SIRASI

1. **Trace’e state ekleme + Replay (B.4)** — en az değişiklik, en yüksek regülasyon değeri.
2. **Confidence + constraint_margin (B.3)** — log ve insan eskalasyonu kriteri.
3. **Hysteresis band (B.2)** — soft_warning log, eşikler config’te.
4. **Stability filter (B.1)** — EMA, a_prev state’i engine’de tutulur.
5. **Regression suite (B.5)** — golden_cases.json + run_regression.py.
6. **Adversarial paket (B.6) + Phase 4.1** — dört test dosyası.
7. **Phase 4.2 Monte Carlo** — senaryo üreteci + toplu çalıştırma + rapor.
8. **Phase 4.3 Chaos** — parametre varyantları + doğrulama.

---

# BÖLÜM E — NİHAİ TANIM

Bu belge ile ami-engine:

- **Deterministik + denetlenebilir + regülasyon uyumlu + araştırma-grade etik karar motoru** olarak tanımlanır.
- Kalite: EMA stabilite, hysteresis, confidence, replay, regression, adversarial ve Monte Carlo / chaos ile sertlenir.
- Strateji: saf çekirdek, sabit anayasa (Phase 1–4), ileride kontrollü kalibrasyon; çekirdek açık bilim, ürünleştirme özel.

**Phase 4’e resmî geçiş:** Bu spec onaylandığı anda Phase 4.1 (Adversarial) ile başlanır; ardından 4.2 ve 4.3 uygulanır.

---

Dünyanın en denetlenebilir etik karar motorunu inşa etmek için bu anayasa referans alınır.
