# Phase 4.4 — Cognitive Uncertainty Engine (Mini-Spec)

**AMI-ENGINE:** AI'ın kendi kararından ne kadar emin olmadığını ölçen modül.

Referans: 04_QUALITY_AND_PHASE4_SPEC, B.3 Confidence, Phase 4.2 Monte Carlo.

---

# 1. Amaç

- Mevcut **confidence + constraint_margin + action dağılımı** üzerine kurulu.
- Yeni "bilinç modeli" eklemek değil; **belirsizlik metrikleri** ile karar kalitesini sayısal hale getirmek.
- Çıktı: Hesitation Index, Decision Entropy, Action Spread, Ethical Volatility → trace + rapor.

---

# 2. Dört Ana Metrik (Matematik)

## 2.1 Hesitation Index (HI)

Sistemin "ne kadar tereddüt ettiği".

**Basit:**
  HI = 1 − confidence

**Zengin (margin ağırlıklı):**
  HI = (1 − confidence) * (1 + sigmoid(−k * constraint_margin)) / 2
  k = UNCERTAINTY_MARGIN_K (config, örn. 5.0). Chaos testlerinde belirsizlik hassasiyeti taranabilir.
  constraint_margin negatifken HI yükselir.

**Aralık:** [0, 1]. Yüksek HI → yüksek tereddüt.

---

## 2.2 Decision Entropy (DE)

Aday aksiyonların skor dağılımından belirsizlik.

**Skorlar:** Her aday a için Score(a) = α*W + β*J − γ*H + δ*C (mevcut formül).

**Olasılık (softmax):**
  p(a) = exp(Score(a)) / Σ exp(Score(a'))

**Entropy:**
  DE = − Σ_a p(a) * log(p(a))
  (0 log 0 = 0)

**Yorum:** DE yüksek → birinci ve diğerleri birbirine yakın (kararsızlık). DE düşük → net bir kazanan.

**Normalize:** DE_max = log(N) (N = aday sayısı). DE_norm = DE / DE_max ∈ [0, 1].

---

## 2.3 Action Spread (AS)

Birinci ile ikinci seçenek arasındaki fark.

  scores_sorted = sorted(Score(a) for a in candidates), descending
  AS = scores_sorted[0] − scores_sorted[1]   (en az 2 aday varsa)
  Aday tek ise AS = 0.

**Yorum:** AS düşük → iki seçenek neredeyse aynı (belirsiz). AS yüksek → net lider.

**Normalize:** AS’i [0,1] bandına çekmek için AS_norm = 1 − exp(−λ * AS), λ = 2 (config).

---

## 2.4 Ethical Volatility (EV)

Aynı raw_state, farklı config’ler (Chaos grid’den bir alt küme) ile çalıştırıldığında seçilen aksiyonun ne kadar değiştiği.

  actions = [ moral_decision_engine(state, config=c)["action"] for c in config_sample ]
  EV = std(L2_norm(actions)) veya EV = mean_pairwise_distance(actions)

**Pratik:** Monte Carlo / Chaos çalıştırılırken aynı state birkaç config ile tekrarlanırsa EV hesaplanabilir. Tek karar anında EV yok (opsiyonel, batch analizi).

**Phase 4.4 ilk aşamada:** HI, DE, AS zorunlu; EV opsiyonel (Phase 4.2/4.3 post-processing).

---

## 2.5 Türetilmiş Metrikler (Mikro-İyileştirmeler)

### Combined Uncertainty Score (CUS)

Tek bir global belirsizlik metriği; soft override, chaos analizi ve dashboard için.

  CUS = w1*HI + w2*DE_norm + w3*(1 − AS_norm)

Varsayılan ağırlıklar: w1=0.4, w2=0.35, w3=0.25 (config’te CUS_WEIGHTS).
Aralık: [0, 1]. Yüksek CUS → yüksek genel belirsizlik.

---

### Confidence–Uncertainty Divergence (D)

Sistem bazen confidence yüksek ama entropy de yüksek olabilir → “fazla özgüvenli ama kararsız” riski.

  D = | confidence − (1 − DE_norm) |

D büyükse: özgüven ile karar dağılımı uyumsuz → **hard safety trigger** adayı (Phase 4.5’te eşik ile kullanılabilir).

---

### Temporal Uncertainty Drift (Phase 5 tohumu)

Aynı kullanıcı/bağlam akışında zaman içinde:

  ΔHI / Δt  veya  CUS(t) − CUS(t−1)

“Model zamanla daha mı kararsız hale geliyor?” sorusu → ileride **drift detection** için. Phase 4.4’te hesaplanmaz; API/trace’te zaman damgası veya step_id bırakılarak Phase 5’te kullanılır.

---

# 3. Pipeline Entegrasyonu

- **Hesitation Index:** confidence ve constraint_margin zaten var → HI engine veya core/uncertainty’de hesaplanır; step 6 (selection) sonrası trace’e eklenir.
- **Decision Entropy:** candidates üzerinden Score(a) hesaplanıyor → aynı adımda p(a) ve DE hesaplanır; DE trace’e eklenir.
- **Action Spread:** candidates’ın skorları sıralanır → AS hesaplanır; trace’e eklenir.
- **Ethical Volatility:** Tek çağrıda değil; batch (aynı state, çok config) sonrası raporlama katmanında.

**Veri akışı:**
  candidates + scores → compute_uncertainty(candidates, scores, confidence, constraint_margin) → { HI, DE, AS }
  → step 6 data’ya eklenir; motor çıktısına uncertainty dict eklenir.

---

# 4. Kod Modülü Taslağı

**Dosya:** core/uncertainty.py

**Config (config.py):**
  UNCERTAINTY_MARGIN_K = 5.0
  UNCERTAINTY_AS_LAMBDA = 2.0
  CUS_WEIGHTS = (0.4, 0.35, 0.25)  # (w1 HI, w2 DE_norm, w3 (1-AS_norm))

**Fonksiyonlar:**

- `hesitation_index(confidence, constraint_margin, k=None)` → k yoksa config.UNCERTAINTY_MARGIN_K
- `decision_entropy(scores, temperature=1.0) -> (de, de_norm)`
- `action_spread(scores, lambda_norm=None) -> (as_raw, as_norm)`
- `combined_uncertainty_score(hi, de_norm, as_norm, weights=None) -> float`
- `confidence_uncertainty_divergence(confidence, de_norm) -> float`
- `compute_uncertainty(confidence, constraint_margin, candidate_scores) -> UncertaintyResult`

**UncertaintyResult (dataclass):**
  hi: float
  de: float
  de_norm: float
  as_: float
  as_norm: float
  cus: float
  divergence: float   # D = |confidence - (1 - DE_norm)|

**Not:** candidate_scores = [ Score(a) for (a,s) in candidates ]; Action Selector’dan önce veya sonra aynı skorlar kullanılır.

**Engine’de:** selection_data’ya uncertainty eklenir; çıktıya uncertainty dict eklenir.

---

# 5. Test Planı

## 5.1 Birim testleri (core/uncertainty.py)

- HI: confidence=1, margin=0.5 → HI düşük; confidence=0.1, margin=−0.2 → HI yüksek.
- DE: Tek skor (N=1) → DE=0; Tüm skorlar eşit (N>1) → DE = log(N) normalize.
- AS: İki aday, skorlar 0.9 ve 0.1 → AS yüksek; 0.51 ve 0.49 → AS düşük.
- CUS: HI, DE_norm, AS_norm verildiğinde CUS ∈ [0,1]; ağırlıklar toplamı 1.
- Divergence: confidence=0.9, DE_norm=0.8 → (1−DE_norm)=0.2 → D=0.7 (yüksek uyumsuzluk).

## 5.2 Entegrasyon (engine.py)

- moral_decision_engine çağrısından dönen result’ta "uncertainty" anahtarı var mı; HI, DE, AS, CUS, divergence ∈ uygun aralık.

## 5.3 Monte Carlo entegrasyonu

- tests/monte_carlo/runner.py: Her kayıtta uncertainty (HI, DE, AS) saklanır.
- tests/monte_carlo/report.py: mean(HI), mean(DE), mean(AS), mean(CUS), divergence dağılımı, histogramları eklenir.
- Raporlama: “Ortalama tereddüt”, “karar entropisi dağılımı”, “aksiyon spread dağılımı”.

## 5.4 Replay

- Trace’te uncertainty varsa replay sonrası aynı uncertainty değerleri assert edilir (determinizm).

---

# 6. Config Profile + 3-Level Escalation (Referans)

Phase 4.4 tamamlandıktan sonra:

**Config profile yapısı (önerilen):**
  config/
    base.py         → DEFAULT_CONFIG (J_MIN, H_MAX, C_MIN, C_MAX, J_CRITICAL, H_CRITICAL)
    production_safe.py → CONFIG = { **DEFAULT_CONFIG, J_MIN: 0.65, H_MAX: 0.40 }
    high_critical.py   → CONFIG = { **DEFAULT_CONFIG, J_MIN: 0.85, H_MAX: 0.25, ... }

Motor: config_override = None ise base; preset adı verilirse ilgili CONFIG kullanılır.

**3 seviyeli escalation (Phase 4.5):**
  - Level 0: Normal; allowed_actions = ALL.
  - Level 1: Soft-Safe; aksiyon uzayı kısıtlanır (örn. severity ≤ 0.6, intervention ≤ 0.5, delay ≥ 0.3).
  - Level 2: Hard Fail-Safe; mevcut safe_action + human_escalation.

  escalation = 2  if confidence < 0.20 or H > H_CRITICAL else
                1  if constraint_margin < 0 else 0

  escalation == 1 iken: candidate_actions = restrict_action_space(candidates, rules=soft_safe_rules).

Bu belge Phase 4.5’te referans alınır; Phase 4.4 sadece ölçüm (HI, DE, AS).

---

# 7. Uygulama Sırası

1. core/uncertainty.py: HI, DE, AS formülleri + compute_uncertainty.
2. engine.py: candidates skorları + confidence/margin → compute_uncertainty; step 6 ve çıktıya uncertainty ekleme.
3. tests/uncertainty/test_uncertainty.py: Birim testleri.
4. tests/monte_carlo/runner.py + report.py: uncertainty kaydı ve raporlama.
5. Replay validate_ethics: uncertainty alanı varsa eşitliği assert et.
6. (Opsiyonel) EV: Chaos/Monte Carlo batch’te aynı state çok config ile çalıştırılıp EV hesaplanır.

---

# 8. Nihai Tanım

Phase 4.4 tamamlandığında:

- Motor her kararda **HI, DE, AS, CUS, divergence** üretir.
- Trace ve raporlama bu metriklerle **karar belirsizliğini** izlenebilir kılar.
- CUS: soft override ve dashboard için tek sayı; divergence: özgüven–belirsizlik uyumsuzluğu (safety trigger).
- Temporal drift (ΔHI/Δt) Phase 5’te; Phase 4.4’te sadece anlık metrikler.
- Phase 4.5 (Soft-Override) ve 4.6 (Adaptive Ethics) bu metrikleri girdi olarak kullanabilir.

Bu spec, Cognitive Uncertainty Engine’in tek referans dokümanıdır.
