# Phase 5 — Temporal Drift Monitor (Mini-Spec)

**AMI-ENGINE:** Zamansal bilinç — sistem henüz fail olmadan risk trendini sezer.

Referans: 06_PHASE_44 (CUS), 09_PHASE_461 (Soft Clamp).

---

# 1. Amaç

- Tek karar anında değil, **zaman içinde** belirsizlik artışını algılamak.
- İnsan analojisi: “İçimde bir şeylerin ters gittiğini hissediyorum.”
- **Preemptive escalation:** ΔCUS veya CUS_mean eşiği aşılınca escalation ≥ 1.

---

# 2. Metrikler

## 2.1 Anlık drift

  ΔCUS = CUS(t) − CUS(t−1)

(İlk adımda t−1 yoksa ΔCUS = 0 veya NaN; preemptive tetiklenmez.)

## 2.2 Kayan pencere ortalaması

  CUS_mean = mean(CUS[t−k : t])

k = pencere boyutu (config: CUS_MEAN_WINDOW).

---

# 3. Kurallar

## 3.1 Delta kuralı

  if ΔCUS > DELTA_CUS_THRESHOLD:
      preemptive_escalation = True  →  escalation = max(escalation, 1)

Varsayılan: DELTA_CUS_THRESHOLD = 0.15.

## 3.2 Ortalama kuralı (trend)

  if CUS_mean > CUS_MEAN_THRESHOLD:
      preemptive_escalation = True  →  escalation = max(escalation, 1)

Varsayılan: CUS_MEAN_THRESHOLD = 0.65.

---

# 4. Durum (State)

Motor tek çağrıda stateless; CUS geçmişi **çağıran tarafça** tutulur.

- **context:** Optional[dict], anahtarı `"cus_history"`: List[float] (son CUS değerleri).
- Çağrı sonrası motor `context["cus_history"]`’i günceller (veya çıktıda `cus_history` döndürür; çağıran bir sonraki çağrıda context’e yazar).
- Pencere: son k değer; yeni CUS eklenir, liste en fazla k uzunlukta tutulur.

---

# 5. Pipeline entegrasyonu

1. uncertainty (CUS) hesaplandıktan sonra:
   - context verilmişse: cus_history’ye CUS ekle, pencereyi k ile sınırla.
   - delta_cus = CUS − last_CUS (history’de en az 2 varsa).
   - cus_mean = mean(cus_history).
2. preemptive = (delta_cus > delta_threshold) or (cus_mean > mean_threshold).
3. escalation = max(escalation, 1) if preemptive else escalation.
4. selection_data ve out’a temporal_drift: { delta_cus, cus_mean, preemptive_escalation } ekle.
5. context güncellenir veya out["cus_history"] ile döndürülür.

---

# 6. Dosya yapısı

**core/temporal_drift.py**

- **update_cus_history(history: List[float], cus: float, window_size: int) -> List[float]**  
  Yeni listeyi döndürür (son window_size eleman).

- **compute_temporal_drift(cus: float, history: List[float], delta_threshold: float, mean_threshold: float) -> DriftResult**  
  DriftResult: delta_cus (float | None), cus_mean (float), preemptive_escalation (bool).

- **should_preemptively_escalate(drift_result: DriftResult) -> bool**  
  drift_result.preemptive_escalation.

---

# 7. Config

  DELTA_CUS_THRESHOLD = 0.15
  CUS_MEAN_WINDOW = 10
  CUS_MEAN_THRESHOLD = 0.65

---

# 8. Replay / determinizm

- context verilmeden replay yapılıyorsa drift hesaplanmaz; mevcut replay davranışı değişmez.
- context verilerek çalıştırıldığında trace’te temporal_drift alanı varsa replay’da aynı context (cus_history) ile aynı drift sonucu üretilir (deterministik).

---

# 9. Uzun vadeli vizyon

- Bu katman: **Cognitive Control Layer** — sistem kendi “psikolojik durumunu” izler.
- İleride: self-regulation, adaptive threshold tuning, learning-based safety envelope.

Bu spec, Temporal Drift Monitor’ün referans dokümanıdır.
