# Phase 4.7 — Trace & Observability (Mini-Spec)

**AMI-ENGINE:** Öğrenme ve görselleştirme için birleşik karar izi (observability core).

Referans: Phase 4.4–5.1, Phase 6 hazırlık.

---

# 1. Amaç

- **Unified trace:** Her karar için tek, standart kayıt (learning dataset + dashboard).
- **Trace collector:** Ring buffer + JSONL; ileride websocket.
- **Phase 6 hazırlık:** Offline learning loop için veri; görselleştirme için kaynak.

---

# 2. Unified Trace Format (DecisionTrace)

Her karar sonrası üretilen kayıt:

```python
DecisionTrace = {
  "t": float,              # timestamp (caller veya time.time())
  "cus": float,
  "delta_cus": float | None,
  "cus_mean": float,
  "raw_action": [s, c, i, d],
  "final_action": [s, c, i, d],
  "soft_clamp": bool,
  "delta_confidence": float | None,
  "level": int,            # escalation 0|1|2
  "confidence": float,
  "uncertainty": float,    # CUS veya genel belirsizlik
  "human_escalation": bool,
}
```

- **raw_action:** Clamp öncesi seçilen aksiyon (engine çıktısında raw_action).
- **final_action:** Clamp sonrası veya aynı (engine action).
- **chaos:** İsteğe bağlı; config override ile chaos çalıştırılıyorsa True.

---

# 3. Trace Collector (core/trace_collector.py)

- **TraceCollector(max_buffer_size=1000, jsonl_path=None)**
  - Ring buffer: son N kayıt bellekte.
  - jsonl_path verilirse her push’ta (veya flush’ta) dosyaya append.
- **push(entry: dict)** — Bir DecisionTrace ekler.
- **get_recent(n: int)** — Son n kayıt.
- **get_all()** — Tüm buffer (en fazla max_buffer_size).
- **flush_jsonl()** — Buffer’ı JSONL’e yazar (isteğe bağlı).
- **build_decision_trace(engine_result, t=None)** — Motor çıktısından DecisionTrace dict üretir; t yoksa time.time().

Engine’e minimal dokunuş: çıktıda **raw_action** (clamp öncesi aksiyon) eklenir; collector çağıran tarafça kullanılır.

---

# 4. Kullanım

```python
from core.trace_collector import TraceCollector, build_decision_trace
from engine import moral_decision_engine
import time

collector = TraceCollector(max_buffer_size=500, jsonl_path="traces.jsonl")
result = moral_decision_engine(raw_state)
entry = build_decision_trace(result, t=time.time())
collector.push(entry)
# get_recent(10), get_all(), flush_jsonl()
```

---

# 5. Phase 4.7.2 — Dashboard (İleride)

- Streamlit: CUS timeline, soft clamp activity, action drift, chaos boundary.
- Veri kaynağı: collector.get_recent() veya JSONL dosyası.

---

# 6. Phase 6.0 Hazırlık

- Learning dataset: JSONL veya get_all() → loss (chaos, drift, delta_confidence, over-escalation) ile eşik/clamp optimizasyonu.
- Bu spec, Trace & Observability’nin referans dokümanıdır.
